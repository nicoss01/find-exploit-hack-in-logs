<?php
ini_set('display_errors',1);
set_time_limit(0);

require __DIR__ . '/vendor/autoload.php';

use MVar\Apache2LogParser\AccessLogParser;
use MVar\LogParser\LogIterator;

// Access log format from your Apache configuration
// It can be any of predefined `AccessLogParser::FORMAT_*` constants or custom string
$parser = new AccessLogParser('%h %l %u %t "%r" %>s %O "%{Referer}i" "%{User-Agent}i"');

$fichiers=array();
if ($handle = opendir(__DIR__."/logs")) {

    while (false !== ($entry = readdir($handle))) {

        if ($entry != "." && $entry != "..") {

           $fichiers[]=$entry;
        }
    }

    closedir($handle);
}
try{
    $db = new PDO('mysql:host=localhost;dbname=hack', 'root', '');
}catch(Exception $e){
    echo "Erreur : ".$e->getMessage();
}
$query="INSERT INTO `logs` ( `remote_host`, `identity`, `remote_user`, `time`, `method`,`request_line`, `response_code`, `bytes_sent`, `request`, `request_headers`) VALUES (:remote_host, :identity, :remote_user, :time, :method, :request_line, :response_code, :bytes_sent, :request, :request_headers)";
$queryFinal=$db->prepare($query);
foreach($fichiers as $fichier){
    echo $fichier."<br>";
    foreach (new LogIterator(__DIR__.'/logs/'.$fichier, $parser) as $line => $data) {
        //var_dump($data,date('Y-m-d H:i:s',strtotime($data['time'])));
        $r=$queryFinal->execute(array(
            'remote_host' => $data['remote_host'],
            'identity' => $data['identity'],
            'remote_user' => $data['remote_user'],
            'time' => date('Y-m-d H:i:s',strtotime($data['time'])),
            'method' => $data['request']['method'],
            'request_line' => $data['request_line'],
            'response_code' => $data['response_code'],
            'bytes_sent' => $data['bytes_sent'],
            'request' => json_encode($data['request']),
            'request_headers' => json_encode($data['request_headers'])
        ));
        if($r==false)
            var_dump($data,$queryFinal->errorCode()." : ".$queryFinal->errorInfo(),array(
                'remote_host' => $data['remote_host'],
                'identity' => $data['identity'],
                'remote_user' => $data['remote_user'],
                'time' => date('Y-m-d H:i:s',strtotime($data['time'])),
                'method' => $data['request']['method'],
                'request_line' => $data['request_line'],
                'response_code' => $data['response_code'],
                'bytes_sent' => $data['bytes_sent'],
                'request' => json_encode($data['request']),
                'request_headers' => json_encode($data['request_headers'])
            )
        );
        
    }
}
?>